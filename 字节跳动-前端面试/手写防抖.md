# æ‰‹å†™é˜²æŠ–ï¼ˆdebounceï¼‰

## é¢˜ç›®
**æ‰‹å†™ä¸€ä¸ªé˜²æŠ–å‡½æ•°**

è¦æ±‚ï¼šå®ç°ä¸€ä¸ªé˜²æŠ–å‡½æ•°ï¼Œæ§åˆ¶å‡½æ•°æ‰§è¡Œçš„é¢‘ç‡ï¼Œé¿å…çŸ­æ—¶é—´å†…å¤šæ¬¡è§¦å‘ã€‚

---

## ğŸ’¡ åŸºç¡€å®ç°

### 1. ç®€å•é˜²æŠ–å®ç°
```javascript
function debounce(func, wait) {
  let timeout;
  
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func.apply(this, args);
    };
    
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
```

---

### 2. æ”¯æŒç«‹å³æ‰§è¡Œçš„é˜²æŠ–
```javascript
function debounce(func, wait, immediate = false) {
  let timeout;
  
  return function executedFunction(...args) {
    const context = this;
    const callNow = immediate && !timeout;
    
    const later = () => {
      timeout = null;
      if (!immediate) {
        func.apply(context, args);
      }
    };
    
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    
    if (callNow) {
      func.apply(context, args);
    }
  };
}
```

---

### 3. TypeScriptç‰ˆæœ¬
```typescript
function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number,
  immediate: boolean = false
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout | null = null;
  
  return function executedFunction(...args: Parameters<T>) {
    const context = this;
    const callNow = immediate && !timeout;
    
    const later = () => {
      timeout = null;
      if (!immediate) {
        func.apply(context, args);
      }
    };
    
    if (timeout) {
      clearTimeout(timeout);
    }
    
    timeout = setTimeout(later, wait);
    
    if (callNow) {
      func.apply(context, args);
    }
  };
}
```

---

### 4. æ”¯æŒå–æ¶ˆå’Œåˆ·æ–°
```javascript
function advancedDebounce(func, wait, options = {}) {
  const {
    leading = false,      // æ˜¯å¦ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡
    trailing = true,      // æ˜¯å¦æ‰§è¡Œæœ€åä¸€æ¬¡
    maxWait = null,       // æœ€å¤§ç­‰å¾…æ—¶é—´
  } = options;
  
  let timeout;
  let lastCallTime = 0;
  let lastInvokeTime = 0;
  let result;
  
  function invokeFunc(time) {
    const args = lastArgs;
    const thisArg = lastThis;
    
    lastArgs = lastThis = undefined;
    lastInvokeTime = time;
    
    return func.apply(thisArg, args);
  }
  
  function leadingEdge(time) {
    lastInvokeTime = time;
    
    // è®¾ç½®è¶…æ—¶ï¼Œç”¨äºå¤„ç†å°¾éšè°ƒç”¨
    timeout = setTimeout(timerExpired, wait);
    
    // å¦‚æœæ˜¯leadingæ¨¡å¼ï¼Œç«‹å³æ‰§è¡Œ
    return leading ? invokeFunc(time) : result;
  }
  
  function remainingWait(time) {
    const timeSinceLastCall = time - lastCallTime;
    const timeSinceLastInvoke = time - lastInvokeTime;
    
    // è®¡ç®—å‰©ä½™ç­‰å¾…æ—¶é—´
    const timeWaiting = wait - timeSinceLastCall;
    
    // å¦‚æœè®¾ç½®äº†maxWaitï¼Œå–æœ€å°å€¼
    return maxWait === null
      ? timeWaiting
      : Math.min(timeWaiting, maxWait - timeSinceLastInvoke);
  }
  
  function shouldInvoke(time) {
    const timeSinceLastCall = time - lastCallTime;
    const timeSinceLastInvoke = time - lastInvokeTime;
    
    // é¦–æ¬¡è°ƒç”¨æˆ–è·ç¦»ä¸Šæ¬¡è°ƒç”¨è¶…è¿‡ç­‰å¾…æ—¶é—´
    return lastCallTime === 0 || timeSinceLastCall >= wait;
  }
  
  function timerExpired() {
    const time = Date.now();
    
    if (shouldInvoke(time)) {
      return trailingEdge(time);
    }
    
    // é‡æ–°è®¾å®šå®šæ—¶å™¨
    timeout = setTimeout(timerExpired, remainingWait(time));
  }
  
  function trailingEdge(time) {
    timeout = undefined;
    
    // åªæœ‰åœ¨æœ‰æŒ‚èµ·çš„æ“ä½œä¸”éœ€è¦å°¾éšæ‰§è¡Œæ—¶æ‰è°ƒç”¨
    if (trailing && lastArgs) {
      return invokeFunc(time);
    }
    
    lastArgs = lastThis = undefined;
    return result;
  }
  
  function cancel() {
    if (timeout !== undefined) {
      clearTimeout(timeout);
    }
    
    lastInvokeTime = 0;
    lastCallTime = 0;
    lastArgs = lastThis = timeout = undefined;
  }
  
  function flush() {
    return timeout === undefined ? result : trailingEdge(Date.now());
  }
  
  function debounced(...args) {
    const time = Date.now();
    const isInvoking = shouldInvoke(time);
    
    lastArgs = args;
    lastThis = this;
    lastCallTime = time;
    
    if (isInvoking) {
      if (timeout === undefined) {
        return leadingEdge(lastCallTime);
      }
      
      if (maxWait !== null) {
        // å¤„ç†é˜²æŠ–çš„æœ€å¤§ç­‰å¾…æ—¶é—´
        clearTimeout(timeout);
        timeout = setTimeout(timerExpired, wait);
        return invokeFunc(lastCallTime);
      }
    }
    
    if (timeout === undefined) {
      timeout = setTimeout(timerExpired, wait);
    }
    
    return result;
  }
  
  let lastArgs;
  let lastThis;
  
  debounced.cancel = cancel;
  debounced.flush = flush;
  
  return debounced;
}
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæœç´¢æ¡†é˜²æŠ–
```javascript
const searchInput = document.getElementById('search');
const searchResults = document.getElementById('results');

// ç®€å•é˜²æŠ–
const debouncedSearch = debounce(function(searchTerm) {
  fetch(`/api/search?q=${searchTerm}`)
    .then(response => response.json())
    .then(data => {
      searchResults.innerHTML = data.map(item => 
        `<li>${item.title}</li>`
      ).join('');
    });
}, 300);

searchInput.addEventListener('input', (e) => {
  debouncedSearch(e.target.value);
});
```

---

### ç¤ºä¾‹2ï¼šçª—å£è°ƒæ•´å¤§å°é˜²æŠ–
```javascript
// ç«‹å³æ‰§è¡Œçš„é˜²æŠ–ï¼ˆç¬¬ä¸€æ¬¡ç«‹å³æ‰§è¡Œï¼‰
const debouncedResize = debounce(function() {
  console.log('Window resized to:', window.innerWidth, window.innerHeight);
  updateLayout();
}, 250, true);

window.addEventListener('resize', debouncedResize);
```

---

### ç¤ºä¾‹3ï¼šæŒ‰é’®ç‚¹å‡»é˜²æŠ–
```javascript
const submitButton = document.getElementById('submit');

// é˜²æ­¢é‡å¤æäº¤
const debouncedSubmit = debounce(function() {
  if (this.disabled) return;
  
  this.disabled = true;
  submitForm()
    .finally(() => {
      this.disabled = false;
    });
}, 1000);

submitButton.addEventListener('click', debouncedSubmit);

// æ”¯æŒå–æ¶ˆ
function cancelSubmit() {
  debouncedSubmit.cancel();
}
```

---

### ç¤ºä¾‹4ï¼šReactç»„ä»¶ä¸­çš„é˜²æŠ–
```javascript
import { useCallback, useEffect, useRef } from 'react';

function SearchComponent() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  
  const debouncedSearch = useCallback(
    debounce(async (searchTerm) => {
      if (!searchTerm.trim()) {
        setResults([]);
        return;
      }
      
      try {
        const response = await fetch(`/api/search?q=${searchTerm}`);
        const data = await response.json();
        setResults(data);
      } catch (error) {
        console.error('Search failed:', error);
      }
    }, 300),
    [] // æ³¨æ„ï¼šè¿™é‡Œçš„ä¾èµ–é¡¹å†³å®šäº†æ˜¯å¦ä¼šåˆ›å»ºæ–°çš„debounceå®ä¾‹
  );
  
  useEffect(() => {
    // ç»„ä»¶å¸è½½æ—¶å–æ¶ˆé˜²æŠ–
    return () => {
      // å¦‚æœæœ‰cancelæ–¹æ³•çš„è¯
      if (debouncedSearch.cancel) {
        debouncedSearch.cancel();
      }
    };
  }, []);
  
  return (
    <div>
      <input
        type="text"
        value={query}
        onChange={(e) => {
          setQuery(e.target.value);
          debouncedSearch(e.target.value);
        }}
        placeholder="Search..."
      />
      <ul>
        {results.map((item) => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

---

## ğŸ”¬ åŸç†åˆ†æ

### é˜²æŠ–çš„æ ¸å¿ƒæ€æƒ³
1. **å»¶è¿Ÿæ‰§è¡Œ**ï¼šä¸æ˜¯æ¯æ¬¡è§¦å‘éƒ½æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´
2. **é‡ç½®å®šæ—¶å™¨**ï¼šæ¯æ¬¡è§¦å‘éƒ½å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé‡æ–°è®¡æ—¶
3. **åªæ‰§è¡Œä¸€æ¬¡**ï¼šåœ¨ç­‰å¾…æ—¶é—´å†…ï¼Œåªæœ‰æœ€åä¸€æ¬¡è§¦å‘ä¼šè¢«æ‰§è¡Œ

### å®ç°è¦ç‚¹
```javascript
// é˜²æŠ–çš„ä¸‰ä¸ªå…³é”®è¦ç´ 
1. å®šæ—¶å™¨ï¼ˆsetTimeout/clearTimeoutï¼‰
2. é—­åŒ…ï¼ˆä¿å­˜çŠ¶æ€ï¼‰
3. å‡½æ•°å¼•ç”¨ï¼ˆè¿”å›æ–°å‡½æ•°ï¼‰

// æ‰§è¡Œæµç¨‹
è§¦å‘ â†’ å–æ¶ˆæ—§å®šæ—¶å™¨ â†’ è®¾å®šæ–°å®šæ—¶å™¨ â†’ ç­‰å¾… â†’ æ‰§è¡Œ
```

---

### é˜²æŠ– vs èŠ‚æµï¼ˆthrottleï¼‰
```javascript
// é˜²æŠ–ï¼šè§¦å‘åç­‰å¾…ä¸€æ®µæ—¶é—´æ‰§è¡Œï¼ŒæœŸé—´å¦‚æœå†æ¬¡è§¦å‘åˆ™é‡æ–°è®¡æ—¶
// èŠ‚æµï¼šå›ºå®šæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡ï¼Œç±»ä¼¼é˜€é—¨æ§åˆ¶æµé‡

åº”ç”¨åœºæ™¯å¯¹æ¯”ï¼š
| åœºæ™¯         | é˜²æŠ–                 | èŠ‚æµ               |
|--------------|----------------------|--------------------|
| æœç´¢æ¡†       | âœ… é¿å…é¢‘ç¹è¯·æ±‚        | âš ï¸ å¯èƒ½ä¼šå»¶è¿Ÿå“åº”    |
| çª—å£è°ƒæ•´     | âš ï¸ å¯èƒ½æŠ–åŠ¨           | âœ… å¹³æ»‘å“åº”         |
| æŒ‰é’®ç‚¹å‡»     | âœ… é˜²æ­¢é‡å¤æäº¤        | âš ï¸ å¯èƒ½å»¶è¿Ÿå“åº”      |
| æ»šåŠ¨äº‹ä»¶     | âš ï¸ å¯èƒ½ä¸æµç•…         | âœ… æ§åˆ¶äº‹ä»¶é¢‘ç‡     |
| é¼ æ ‡ç§»åŠ¨     | âš ï¸ å¯èƒ½å¡é¡¿           | âœ… æµç•…è·Ÿè¸ª         |
```

---

## ğŸ¢ å­—èŠ‚è·³åŠ¨å®é™…åº”ç”¨

### æŠ–éŸ³ä¸­çš„é˜²æŠ–åº”ç”¨
```javascript
// æŠ–éŸ³æœç´¢é˜²æŠ–ç­–ç•¥
1. **è”æƒ³è¯æœç´¢**ï¼šè¾“å…¥æ—¶é˜²æŠ–è¯·æ±‚è”æƒ³è¯ï¼ˆ300msï¼‰
2. **å†…å®¹åŠ è½½**ï¼šæ»šåŠ¨æ—¶é˜²æŠ–åŠ è½½æ›´å¤šå†…å®¹
3. **ç”¨æˆ·äº’åŠ¨**ï¼šç‚¹èµã€è¯„è®ºç­‰æ“ä½œé˜²æŠ–æäº¤

// å®ç°ç‰¹ç‚¹
- åˆ†çº§é˜²æŠ–ï¼šä¸åŒæ“ä½œä½¿ç”¨ä¸åŒçš„ç­‰å¾…æ—¶é—´
- æ™ºèƒ½å–æ¶ˆï¼šç½‘ç»œå»¶è¿Ÿæ—¶è‡ªåŠ¨å–æ¶ˆæ—§è¯·æ±‚
- æœ¬åœ°ç¼“å­˜ï¼šé˜²æŠ–æœŸé—´ä½¿ç”¨æœ¬åœ°ç¼“å­˜æé«˜å“åº”
```

---

### å¤´æ¡æœç´¢ä¸­çš„é˜²æŠ–
```javascript
// å¤´æ¡æœç´¢é˜²æŠ–ä¼˜åŒ–
1. **å®æ—¶æœç´¢**ï¼šæ‰“å­—æ—¶å®æ—¶æ˜¾ç¤ºç»“æœï¼ˆ200msé˜²æŠ–ï¼‰
2. **çƒ­ç‚¹è¿½è¸ª**ï¼šçƒ­ç‚¹å…³é”®è¯å¿«é€Ÿå“åº”ï¼ˆ100msé˜²æŠ–ï¼‰
3. **ä¸ªæ€§åŒ–æ¨è**ï¼šæ ¹æ®è¡Œä¸ºé˜²æŠ–æ›´æ–°æ¨è

// æ€§èƒ½ä¼˜åŒ–
- è¯·æ±‚åˆå¹¶ï¼šçŸ­æ—¶é—´å†…åˆå¹¶å¤šä¸ªæœç´¢è¯·æ±‚
- ç»“æœç¼“å­˜ï¼šé˜²æŠ–æœŸé—´æ˜¾ç¤ºç¼“å­˜ç»“æœ
- ä¼˜å…ˆçº§è°ƒåº¦ï¼šé‡è¦è¯·æ±‚ä½¿ç”¨æ›´çŸ­çš„é˜²æŠ–æ—¶é—´
```

---

## ğŸ“Š å¤æ‚åº¦åˆ†æ

### æ—¶é—´å¤æ‚åº¦
- **O(1)**ï¼šæ¯æ¬¡è§¦å‘éƒ½æ˜¯å¸¸æ•°æ—¶é—´æ“ä½œ
- **å®šæ—¶å™¨æ“ä½œ**ï¼šclearTimeoutå’ŒsetTimeoutæ˜¯å¸¸æ•°æ—¶é—´

### ç©ºé—´å¤æ‚åº¦
- **O(1)**ï¼šåªä½¿ç”¨å¸¸æ•°é¢å¤–ç©ºé—´
- **é—­åŒ…å˜é‡**ï¼štimeoutã€lastArgsç­‰å˜é‡å ç”¨å›ºå®šç©ºé—´

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

```javascript
// æµ‹è¯•é˜²æŠ–å‡½æ•°
describe('debounce', () => {
  let func;
  let debouncedFunc;
  let mockDate;
  
  beforeEach(() => {
    func = jest.fn();
    debouncedFunc = debounce(func, 100);
    mockDate = jest.spyOn(Date, 'now');
  });
  
  afterEach(() => {
    mockDate.mockRestore();
    jest.clearAllTimers();
  });
  
  test('should call function only once after delay', () => {
    debouncedFunc();
    debouncedFunc();
    debouncedFunc();
    
    expect(func).not.toHaveBeenCalled();
    
    jest.advanceTimersByTime(100);
    expect(func).toHaveBeenCalledTimes(1);
  });
  
  test('should cancel subsequent calls', () => {
    debouncedFunc();
    jest.advanceTimersByTime(50);
    debouncedFunc(); // é‡ç½®è®¡æ—¶å™¨
    jest.advanceTimersByTime(50);
    
    expect(func).not.toHaveBeenCalled();
    
    jest.advanceTimersByTime(50); // æ€»å…±150ms
    expect(func).toHaveBeenCalledTimes(1);
  });
  
  test('should support immediate execution', () => {
    const immediateDebounced = debounce(func, 100, true);
    
    immediateDebounced();
    expect(func).toHaveBeenCalledTimes(1);
    
    immediateDebounced();
    immediateDebounced();
    expect(func).toHaveBeenCalledTimes(1);
    
    jest.advanceTimersByTime(100);
    immediateDebounced();
    expect(func).toHaveBeenCalledTimes(2);
  });
});
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯1ï¼šé”™è¯¯ä½¿ç”¨this
```javascript
// é”™è¯¯ç¤ºä¾‹
function badDebounce(func, wait) {
  let timeout;
  
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      func(...args); // è¿™é‡Œçš„thisæŒ‡å‘window/global
    }, wait);
  };
}

// æ­£ç¡®ï¼šä½¿ç”¨applyæˆ–callä¿æŒthis
timeout = setTimeout(() => {
  func.apply(this, args);
}, wait);
```

### é”™è¯¯2ï¼šå†…å­˜æ³„æ¼
```javascript
// é”™è¯¯ï¼šæ²¡æœ‰æ¸…ç†å®šæ—¶å™¨
function leakyDebounce(func, wait) {
  let timeout;
  
  return function() {
    timeout = setTimeout(func, wait); // æ—§çš„å®šæ—¶å™¨æ²¡æœ‰è¢«æ¸…ç†
  };
}

// æ­£ç¡®ï¼šæ¯æ¬¡éƒ½æ¸…ç†æ—§å®šæ—¶å™¨
clearTimeout(timeout);
timeout = setTimeout(func, wait);
```

### é”™è¯¯3ï¼šä¸æ”¯æŒå‚æ•°ä¼ é€’
```javascript
// é”™è¯¯ï¼šä¸¢å¤±å‚æ•°
function noArgsDebounce(func, wait) {
  let timeout;
  
  return function() {
    clearTimeout(timeout);
    timeout = setTimeout(func, wait); // å‚æ•°ä¸¢å¤±
  };
}

// æ­£ç¡®ï¼šä¿å­˜å‚æ•°
const args = arguments;
timeout = setTimeout(() => {
  func.apply(this, args);
}, wait);
```

---

## âœ¨ æ‰©å±•æ€è€ƒ

### 1. å¦‚ä½•æ”¯æŒå¤šä¸ªå‡½æ•°çš„é˜²æŠ–ï¼Ÿ
```javascript
class DebounceManager {
  constructor() {
    this.debounceMap = new Map();
  }
  
  register(func, wait, key) {
    const debounced = debounce(func, wait);
    this.debounceMap.set(key, debounced);
    return debounced;
  }
  
  cancel(key) {
    const debounced = this.debounceMap.get(key);
    if (debounced && debounced.cancel) {
      debounced.cancel();
    }
  }
  
  flush(key) {
    const debounced = this.debounceMap.get(key);
    if (debounced && debounced.flush) {
      return debounced.flush();
    }
  }
}
```

### 2. å¦‚ä½•å®ç°è‡ªé€‚åº”é˜²æŠ–ï¼Ÿ
```javascript
function adaptiveDebounce(func, options = {}) {
  const {
    minWait = 100,
    maxWait = 1000,
    factor = 1.5,
  } = options;
  
  let wait = minWait;
  let timeout;
  
  return function executedFunction(...args) {
    const context = this;
    
    clearTimeout(timeout);
    
    const startTime = Date.now();
    
    const later = () => {
      const endTime = Date.now();
      const executionTime = endTime - startTime;
      
      // è‡ªé€‚åº”è°ƒæ•´ç­‰å¾…æ—¶é—´
      if (executionTime > wait) {
        wait = Math.min(wait * factor, maxWait);
      } else {
        wait = Math.max(wait / factor, minWait);
      }
      
      func.apply(context, args);
    };
    
    timeout = setTimeout(later, wait);
  };
}
```

---

**æœ¬é¢˜æ¥æº**ï¼šå­—èŠ‚è·³åŠ¨çœŸå®é¢è¯•é¢˜ï¼ˆæ˜é‡‘é¢ç»ä½œè€…ï¼š3800ï¼‰
**éš¾åº¦è¯„çº§**ï¼šâ­â­â­ï¼ˆä¸­ç­‰é¢‘ç‡é¢˜ï¼‰
**å…¬å¸æ ‡ç­¾**ï¼šå­—èŠ‚è·³åŠ¨ã€é˜¿é‡Œã€è…¾è®¯ã€ç¾å›¢ã€å¿«æ‰‹